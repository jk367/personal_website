{{ define "main" }}
<div class="music-content">
    <h1>{{ .Title }}</h1>
    <p>I have been making music since 2016 under many different names: Breeq, Mark X Steiner, ^%(!@@$$$, J-Ket, but now I go by Kettle. I mostly make electronic music, but sometimes venture off into other genres. I also DJ on occasion, I prefer to do longer sets and playing on vinyl.</p>
    
    <div class="button-group" id="genreFilters">
        <button class="genre-filter active" data-genre="all">All Genres</button>
        {{ range $genre := .Site.Taxonomies.genres }}
            <button class="genre-filter" data-genre="{{ $genre.Page.Title }}">{{ $genre.Page.Title }}</button>
        {{ end }}
    </div>

    <h2>Mixes</h2>
    <div id="mixes" class="track-section">
        {{ $mixes := where .Pages "Params.music_categories" "intersect" (slice "mixes") }}
        {{ $sortedMixes := sort $mixes "Params.rank" "desc" }}
        {{ range $index, $element := $sortedMixes }}
            <div class="track-item{{ if ge $index 4 }} hidden{{ end }}" data-genres="{{ delimit .Params.genres " " }}">
                <div class="soundcloud-embed" data-src="{{ .Params.soundcloud_url }}">
                    <div class="placeholder">Loading...</div>
                </div>
            </div>
        {{ else }}
            <p>No mixes found.</p>
        {{ end }}
    </div>

    <h2>Original Productions</h2>
    <div id="productions" class="track-section">
        {{ $productions := where .Pages "Params.music_categories" "intersect" (slice "productions") }}
        {{ $sortedProductions := sort $productions "Params.rank" "desc" }}
        {{ range $index, $element := $sortedProductions }}
            <div class="track-item{{ if ge $index 4 }} hidden{{ end }}" data-genres="{{ delimit .Params.genres " " }}">
                
                <div class="soundcloud-embed" data-src="{{ .Params.soundcloud_url }}">
                    <div class="placeholder">Loading...</div>
                </div>
            </div>
        {{ else }}
            <p>No productions found.</p>
        {{ end }}
    </div>

    <style>
        button {
            background-color: white;
            color: black;
            border: 1px solid black;
            padding: 5px 10px;
            font-family: Garamond, serif;
            font-size: 16px;
            transition: background-color 0.3s ease, color 0.3s ease;
            cursor: pointer;
            margin: 0 5px 5px 0;
        }
        button:hover, button.active {
            background-color: black;
            color: white;
        }
    
        .track-section {
            margin-bottom: 5px;
        }
    
        .track-item {
            margin-bottom: 5px;
        }
    
        iframe {
            margin-bottom: 10px;
        }
        .hidden {
            display: none;
        }
        .genre-filter.active {
            background-color: black;
            color: white;
        }
        .placeholder {
            width: 100%;
            height: 125px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-style: italic;
            color: rgb(0, 0, 0);
        }
    </style>

<script>
    // Preload SoundCloud Widget API
    var sc = document.createElement('script');
    sc.src = 'https://w.soundcloud.com/player/api.js';
    document.head.appendChild(sc);

    document.addEventListener('DOMContentLoaded', function() {
        const genreFilters = document.querySelectorAll('.genre-filter');
        const trackItems = document.querySelectorAll('.track-item');
        const loadMoreButton = document.getElementById('loadMore');
        let hasUserInteracted = false;
        let currentPage = 1;
        const itemsPerPage = 4;

        function loadSoundCloudWidget(element) {
            if (!element || element.classList.contains('loaded')) return;
            const iframe = document.createElement('iframe');
            const url = new URL('https://w.soundcloud.com/player/');
            url.searchParams.append('url', element.dataset.src);
            url.searchParams.append('color', '%23ff5500');
            url.searchParams.append('auto_play', 'false');
            url.searchParams.append('hide_related', 'true');
            url.searchParams.append('show_comments', 'false');
            url.searchParams.append('show_user', 'true');
            url.searchParams.append('show_reposts', 'false');
            url.searchParams.append('show_teaser', 'false');
            url.searchParams.append('visual', 'false');
            url.searchParams.append('hide_mobile_message', 'true');
            
            iframe.setAttribute('src', url.toString());
            iframe.setAttribute('width', '100%');
            iframe.setAttribute('height', '125');
            iframe.setAttribute('frameborder', 'no');
            iframe.setAttribute('scrolling', 'no');
            iframe.setAttribute('allow', 'autoplay');
            element.innerHTML = '';
            element.appendChild(iframe);
            element.classList.add('loaded');
        }

        function lazyLoad() {
            const lazyEmbeds = document.querySelectorAll('.soundcloud-embed:not(.loaded)');
            lazyEmbeds.forEach(embed => {
                if (isInViewport(embed)) {
                    loadSoundCloudWidget(embed);
                }
            });
        }

        function isInViewport(element) {
            if (!element) return false;
            const rect = element.getBoundingClientRect();
            return (
                rect.top >= 0 &&
                rect.left >= 0 &&
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                rect.right <= (window.innerWidth || document.documentElement.clientWidth)
            );
        }

        function applyFilter(genre) {
            let visibleMixes = 0;
            let visibleProductions = 0;
            trackItems.forEach(item => {
                if (!item) return;
                const isMix = item.closest('#mixes') !== null;
                if (hasUserInteracted) {
                    item.classList.remove('hidden');
                }
                if (genre === 'all' || item.getAttribute('data-genres').includes(genre)) {
                    if ((isMix && visibleMixes < itemsPerPage) || (!isMix && visibleProductions < itemsPerPage) || hasUserInteracted) {
                        item.style.display = '';
                        if (isMix) visibleMixes++;
                        else visibleProductions++;
                    } else {
                        item.style.display = 'none';
                    }
                } else {
                    item.style.display = 'none';
                }
            });
            if (loadMoreButton) {
                loadMoreButton.style.display = ((visibleMixes >= itemsPerPage || visibleProductions >= itemsPerPage) && !hasUserInteracted) ? 'block' : 'none';
            }
            lazyLoad();
        }

        genreFilters.forEach(filter => {
            filter.addEventListener('click', function() {
                const genre = this.getAttribute('data-genre');
                genreFilters.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                hasUserInteracted = true;
                currentPage = 1;
                applyFilter(genre);
            });
        });

        if (loadMoreButton) {
            loadMoreButton.addEventListener('click', function() {
                currentPage++;
                let newlyVisibleCount = 0;

                trackItems.forEach((item) => {
                    if (item && item.style.display === 'none' && !item.classList.contains('hidden')) {
                        item.style.display = '';
                        newlyVisibleCount++;
                    }
                });

                if (newlyVisibleCount === 0) {
                    this.style.display = 'none';
                }
                lazyLoad();
            });
        }

        // Initial filter application and lazy load
        applyFilter('all');

        // Lazy load on scroll and resize, with debounce
        let lazyLoadTimeout;
        function debouncedLazyLoad() {
            clearTimeout(lazyLoadTimeout);
            lazyLoadTimeout = setTimeout(lazyLoad, 100);
        }
        window.addEventListener('scroll', debouncedLazyLoad);
        window.addEventListener('resize', debouncedLazyLoad);
    });
</script>
{{ end }}