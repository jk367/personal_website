{{ define "main" }}
<style>
    .homepage-header {
        margin-bottom: 0.5rem;
    }

    .homepage-header h1 {
        margin-bottom: 0.5rem;
    }

    .featured-section {
        margin-bottom: 0.5rem;
        min-height: 100px; /* Prevent layout shift for all sections */
    }

    .featured-section:last-child {
        margin-bottom: 0;
    }

    .section-title {
        text-decoration: none;
        color: inherit;
    }

    .section-title:hover {
        text-decoration: underline;
    }

    /* Daily Haiku Styles - PREVENT LAYOUT SHIFT */
    #haiku-section {
        min-height: 160px;
        position: relative;
    }

    .haiku-content {
        line-height: 1.6;
        margin-top: 0.5rem;
    }

    .haiku-content .haiku-line {
        display: block;
        margin-bottom: 0.2rem;
        line-height: 1.6;
        min-height: 1.6em;
    }

    .haiku-date {
        font-size: 0.9em;
        color: #000;
        margin-top: 0.5rem;
        min-height: 1.3em;
    }

    .photo-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
        margin-top: 0.5rem;
    }

    .photo-item {
        position: relative;
        overflow: hidden;
        aspect-ratio: 3/2;
        max-width: 450px;
    }

    .photo-item a {
        display: block;
        width: 100%;
        height: 100%;
    }

    .photo-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .article-list {
        margin-top: 0.5rem;
    }

    .article-item {
        margin-bottom: 0.5rem;
    }

    .article-item:last-child {
        margin-bottom: 0;
    }

    .article-title {
        display: inline;
        margin-right: 0.5rem;
        font-size: 1.2em;
    }

    .article-title a {
        text-decoration: none;
        color: inherit;
    }

    .article-title a:hover {
        text-decoration: underline;
    }

    .article-date {
        display: inline;
        font-size: 0.9em;
        color: #666;
    }

    .contact-content {
        margin-top: 0.5rem;
    }

    .contact-link {
        color: black;
        text-decoration: none;
        font-size: 1em;
    }

    .contact-link:hover {
        text-decoration: underline;
    }

    @media (max-width: 600px) {
        .photo-grid {
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }

        .photo-item {
            aspect-ratio: 4/3; /* Better mobile aspect ratio - only on mobile */
        }

        .article-title {
            font-size: 1.1em;
        }

        #haiku-section {
            min-height: 140px;
        }
    }

    @media (min-width: 601px) and (max-width: 900px) {
        .photo-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.6rem;
        }
    }

    @media (max-width: 480px) {
        .photo-grid {
            gap: 0.4rem;
        }

        .featured-section {
            margin-bottom: 0.75rem;
        }

    }
</style>

<div class="homepage-header">
    <h1>J.M. Kettle</h1>
    <p>I am a writer and photographer. Currently based in NYC.</p>
</div>

<div class="featured-section">
    <h2><a href="/writing/" class="section-title">Writing</a></h2>
    <div class="article-list">
        {{ $writingPages := where .Site.RegularPages "Section" "writing" }}
        {{ range first 3 $writingPages }}
            <article class="article-item">
                <h3 class="article-title"><a href="{{ .Permalink }}">{{ .Title }}</a></h3>
                <span class="article-date">{{ .Date.Format "Jan 2, 2006" }}</span>
            </article>
        {{ else }}
            <p>No featured articles available.</p>
        {{ end }}
    </div>
</div>

{{ $firstPhoto := true }}
<div class="featured-section">
    <h2><a href="/photos/" class="section-title">Photos</a></h2>
    <div class="photo-grid" id="photo-grid">
        <!-- Photos will be loaded by JavaScript -->
        <noscript>
            {{ $photoPages := where .Site.RegularPages "Section" "photos" }}
            {{ range first 3 $photoPages }}
                {{ if .Params.cloudflare_id }}
                <div class="photo-item">
                    <a href="{{ .Permalink }}">
                        <picture>
                            <source media="(max-width: 768px)" srcset="https://imagedelivery.net/AdXrFVpOozxXjKClzp0UEQ/{{ .Params.cloudflare_id }}/gridthumb">
                            <img src="https://imagedelivery.net/AdXrFVpOozxXjKClzp0UEQ/{{ .Params.cloudflare_id }}/griddisplay"
                                 width="600"
                                 height="400"
                                 alt="{{ .Params.alt | default .Title }}"
                                 {{ if $firstPhoto }}fetchpriority="high" loading="eager"{{ else }}loading="lazy"{{ end }}>
                        </picture>
                             {{ $firstPhoto = false }}
                    </a>
                </div>
                {{ end }}
            {{ else }}
                <p>No featured photos available.</p>
            {{ end }}
        </noscript>
    </div>
</div>

<!-- Embed photo data for JavaScript -->
<script type="application/json" id="photo-data">
{{ $photoPages := where .Site.RegularPages "Section" "photos" }}
{{ $photos := slice }}
{{ range $photoPages }}
    {{ if and .Params.cloudflare_id (not .Params.draft) }}
        {{ $photos = $photos | append (dict "permalink" .Permalink "cloudflare_id" .Params.cloudflare_id "title" .Title "alt" (default .Title .Params.alt)) }}
    {{ end }}
{{ end }}
{{ $photos | jsonify | safeJS }}
</script>

<!-- Random photo selection script -->
<script>
(function() {
    // Get photo data
    const photoDataEl = document.getElementById('photo-data');
    if (!photoDataEl) return;

    let photos;
    try {
        photos = JSON.parse(photoDataEl.textContent);
    } catch (e) {
        console.error('Failed to parse photo data:', e);
        return;
    }

    if (!photos || photos.length === 0) return;

    // Fisher-Yates shuffle
    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    // Select 3 random photos
    const selectedPhotos = shuffleArray(photos).slice(0, 3);

    // Create photo grid
    const photoGrid = document.getElementById('photo-grid');
    if (!photoGrid) return;

    // Clear any existing content
    photoGrid.innerHTML = '';

    // Add each photo
    selectedPhotos.forEach((photo, index) => {
        const photoItem = document.createElement('div');
        photoItem.className = 'photo-item';

        const link = document.createElement('a');
        link.href = photo.permalink;

        const baseUrl = 'https://imagedelivery.net/AdXrFVpOozxXjKClzp0UEQ/';

        const picture = document.createElement('picture');

        const source = document.createElement('source');
        source.media = '(max-width: 768px)';
        source.srcset = `${baseUrl}${photo.cloudflare_id}/gridthumb`;

        const img = document.createElement('img');
        img.src = `${baseUrl}${photo.cloudflare_id}/griddisplay`;
        img.width = 600;
        img.height = 400;
        img.alt = photo.alt || photo.title;

        // First image loads eagerly, others lazy
        if (index === 0) {
            img.setAttribute('fetchpriority', 'high');
            img.loading = 'eager';
        } else {
            img.loading = 'lazy';
        }

        picture.appendChild(source);
        picture.appendChild(img);
        link.appendChild(picture);
        photoItem.appendChild(link);
        photoGrid.appendChild(photoItem);
    });
})();
</script>

<!-- Daily Haiku Section -->
{{ $haikuPage := .Site.GetPage "/writing/daily haikus.md" }}
{{ if $haikuPage }}
{{ $content := $haikuPage.RawContent }}
{{ $lines := split $content "\n" }}

{{ $today := now.Format "January 2, 2006" }}
{{ $todayFormatted := printf "**%s**" $today }}

{{ $haikuFound := false }}
{{ $currentDate := "" }}
{{ $haikuLines := slice }}
{{ $searchingForToday := true }}

<!-- First pass: Look for today's haiku -->
{{ range $lines }}
    {{ if and (hasPrefix . "**") (hasSuffix . "**") $searchingForToday }}
        {{ $lineDate := trim (trim . "**") " " }}
        {{ if eq $lineDate $today }}
            {{ $currentDate = $lineDate }}
            {{ $haikuLines = slice }}
        {{ end }}
    {{ else if and (ne . "") (eq $currentDate $today) (not $haikuFound) (not (hasPrefix . "---")) (not (hasPrefix . "title:")) (not (hasPrefix . "date:")) (not (hasPrefix . "writing_categories:")) (not (hasPrefix . "draft:")) (not (hasPrefix . "**")) }}
        {{ $haikuLines = $haikuLines | append . }}
        {{ if eq (len $haikuLines) 3 }}
            {{ $haikuFound = true }}
            {{ $searchingForToday = false }}
        {{ end }}
    {{ end }}
{{ end }}

{{ if not $haikuFound }}
    {{ $currentDate = "" }}
    {{ $haikuLines = slice }}
    {{ $foundFirstDate := false }}
    {{ range $lines }}
        {{ if and (hasPrefix . "**") (hasSuffix . "**") (not $foundFirstDate) }}
            {{ $currentDate = trim (trim . "**") " " }}
            {{ $haikuLines = slice }}
            {{ $foundFirstDate = true }}
        {{ else if and (ne . "") (ne $currentDate "") $foundFirstDate (not $haikuFound) (not (hasPrefix . "---")) (not (hasPrefix . "title:")) (not (hasPrefix . "date:")) (not (hasPrefix . "writing_categories:")) (not (hasPrefix . "draft:")) (not (hasPrefix . "**")) }}
            {{ $haikuLines = $haikuLines | append . }}
            {{ if eq (len $haikuLines) 3 }}
                {{ $haikuFound = true }}
            {{ end }}
        {{ end }}
    {{ end }}
{{ end }}

{{ if $haikuFound }}
<div class="featured-section" id="haiku-section">
    <h2><a href="/writing/daily-haikus/" class="section-title">Daily Haiku</a></h2>
    <div class="haiku-date">{{ $currentDate }}</div>
    <div class="haiku-content">
        {{ range $haikuLines }}
        <span class="haiku-line">{{ . }}</span>
        {{ end }}
    </div>
</div>
{{ end }}
{{ end }}

<div class="featured-section">
    <h2>Contact</h2>
    <div class="contact-content">
        <a href="mailto:contact@jmkettle.com" class="contact-link">Email at contact@jmkettle.com</a>
    </div>
</div>
{{ end }}
